---
- name: Filter unique staks
  ansible.builtin.set_fact:
    container_stacks: "{{ containers | map(attribute='stack') | unique | list }}"

- name: Ensure destination for compose file exists
  ansible.builtin.file:
    path: "{{ docker_compose_generator_output_path }}/{{ item }}"
    owner: "{{ docker_compose_generator_uid }}"
    group: "{{ docker_compose_generator_gid }}"
    state: directory
  loop: "{{ container_stacks }}"

- name: Write docker-compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ docker_compose_generator_output_path }}/{{ loop_stack }}/docker-compose.yml"
    owner: "{{ docker_compose_generator_uid }}"
    group: "{{ docker_compose_generator_gid }}"
  loop: "{{ container_stacks }}"
  loop_control:
    loop_var: loop_stack
  vars:
    stack_containers: "{{ containers | selectattr('stack', '==', loop_stack) }}"
